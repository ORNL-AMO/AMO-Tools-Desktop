<form [formGroup]="form" #formElement>


  <div class="form-group">
    <label for="billedForDemand">How are you billed for Demand</label>
    <select id="billedForDemand" class="form-control" formControlName="billedForDemand"
      (focus)="focusField('billedForDemand')" (change)="setBilledForDemand()">
      <option [value]="BilledForDemand.REAL_POWER">Real Power (kW)</option>
      <option [value]="BilledForDemand.APPARENT_POWER" *ngIf="form.value.adjustedOrActual != AdjustedOrActual.BOTH">
        Apparent Power (kVA)</option>
    </select>
  </div>

  <div *ngIf="form.value.billedForDemand == BilledForDemand.REAL_POWER" class="form-group">
    <label for="minimumPowerFactor">Minimum Required Power Factor</label>
    <input class="form-control" type="number" step="any" formControlName="minimumPowerFactor" id="minimumPowerFactor"
      (input)="calculate()" (focus)="focusField('minimumPowerFactor')">
    <div class="alert-danger pull-right small"
      *ngIf="form.get('minimumPowerFactor').invalid && (form.get('minimumPowerFactor').dirty || form.get('minimumPowerFactor').touched)">
      <span *ngIf="form.get('minimumPowerFactor').errors?.required">Required.</span>
      <span *ngIf="form.get('minimumPowerFactor').errors?.min">Must be greater than 0.</span>
      <span *ngIf="form.get('minimumPowerFactor').errors?.max">Must be less than 1.</span>
    </div>
  </div>

  <div *ngIf="form.value.billedForDemand == BilledForDemand.APPARENT_POWER" class="form-group">
    <label for="targetPowerFactor">Target Power Factor</label>
    <input class="form-control" type="number" step="any" formControlName="targetPowerFactor" id="targetPowerFactor"
      (input)="calculate()" (focus)="focusField('targetPowerFactor')">
  </div>

  <div class="form-group">
    <label for="adjustedOrActual">PF Adjusted or Actual Demand</label>
    <select id="adjustedOrActual" class="form-control" formControlName="adjustedOrActual"
      (focus)="focusField('adjustedOrActual')" (change)="setAdjustedOrActual()">
      <option [value]="AdjustedOrActual.POWER_FACTOR">Power Factor</option>
      <option [value]="AdjustedOrActual.ACTUAL_DEMAND">Actual Demand</option>
      <option *ngIf="form.value.billedForDemand != BilledForDemand.APPARENT_POWER" [value]="AdjustedOrActual.BOTH">Both
      </option>
    </select>
  </div>

  <div class="form-group">
    <label for="marginalCostOfDemand">Marginal Cost of Demand</label>
    <div class="input-group  calc-addon-group">
      <input class="form-control" type="number" step="any" name="marginalCostOfDemand"
        formControlName="marginalCostOfDemand" id="marginalCostOfDemand" (input)="calculate()"
        (focus)="focusField('marginalCostOfDemand')">
      <span class="input-group-addon units">$/kVA</span>
    </div>
    <div class="alert-danger pull-right small"
      *ngIf="form.get('marginalCostOfDemand').invalid && (form.get('marginalCostOfDemand').dirty || form.get('marginalCostOfDemand').touched)">
      <span *ngIf="form.get('marginalCostOfDemand').errors?.required">Required.</span>
      <span *ngIf="form.get('marginalCostOfDemand').errors?.min">Must be greater than 0.</span>
    </div>
  </div>

  <div class="form-group">
    <label for="costOfStaticCapacitance">Cost of Static Capacitance</label>
    <div class="input-group  calc-addon-group">
      <input class="form-control" type="number" step="any" formControlName="costOfStaticCapacitance"
        id="costOfStaticCapacitance" (input)="calculate()" (focus)="focusField('costOfStaticCapacitance')">
      <span class="input-group-addon units">$/kVAr</span>
    </div>
    <div class="alert-danger pull-right small"
      *ngIf="form.get('costOfStaticCapacitance').invalid && (form.get('costOfStaticCapacitance').dirty || form.get('costOfStaticCapacitance').touched)">
      <span *ngIf="form.get('costOfStaticCapacitance').errors?.required">Required.</span>
      <span *ngIf="form.get('costOfStaticCapacitance').errors?.min">Must be greater than 0.</span>
    </div>
  </div>

  <div class="form-group">
    <label for="costOfDynamicCapacitance">Cost of Dynamic Capacitance</label>
    <div class="input-group">
      <input class="form-control" type="number" step="any" formControlName="costOfDynamicCapacitance"
        id="costOfDynamicCapacitance" (input)="calculate()" (focus)="focusField('costOfDynamicCapacitance')">
      <span class="input-group-addon units">$/kVAr</span>
    </div>
    <div class="alert-danger pull-right small" *ngIf="form.get('costOfDynamicCapacitance').invalid">
      <span *ngIf="form.get('costOfDynamicCapacitance').errors?.required">Required.</span>
      <span *ngIf="form.get('costOfDynamicCapacitance').errors?.min">Must be greater than 0.</span>
    </div>
  </div>

  <div class="form-group">
    <label for="startMonth">Starting Month</label>
    <select id="startMonth" class="form-control" formControlName="startMonth" (focus)="focusField('startMonth')"
      (change)="setMonthNames()">
      <option *ngFor="let option of monthList" [ngValue]="option.value">{{option.name}}</option>
    </select>
  </div>

  <div class="form-group">
    <label for="startYear">Starting Year</label>
    <input class="form-control" type="number" step="any" formControlName="startYear" id="startYear"
      (input)="updateStartingYear()" (focus)="focusField('startYear')">
  </div>
</form>

<table class="table table-hover">
  <tr>
    <th>
      Month
    </th>

    <th>
      <span *ngIf="billedForDemand == BilledForDemand.REAL_POWER && 
                (adjustedOrActual == AdjustedOrActual.POWER_FACTOR || adjustedOrActual == AdjustedOrActual.BOTH)">
        PF Adjusted Demand (kW)
      </span>
      <span *ngIf="billedForDemand == BilledForDemand.APPARENT_POWER && adjustedOrActual != AdjustedOrActual.BOTH">
        Apparent Power (kVA)
      </span>
      <span *ngIf="billedForDemand == BilledForDemand.REAL_POWER && adjustedOrActual == AdjustedOrActual.ACTUAL_DEMAND">
        Actual Demand (kW)
      </span>
    </th>

    <th>
      <span
        *ngIf="(billedForDemand == BilledForDemand.REAL_POWER && adjustedOrActual != AdjustedOrActual.BOTH) 
                  || (billedForDemand == BilledForDemand.APPARENT_POWER && adjustedOrActual == AdjustedOrActual.POWER_FACTOR)">
        Power Factor
      </span>
      <span
        *ngIf="(billedForDemand == BilledForDemand.REAL_POWER && adjustedOrActual == AdjustedOrActual.BOTH) || (billedForDemand == BilledForDemand.APPARENT_POWER && adjustedOrActual == AdjustedOrActual.ACTUAL_DEMAND)">
        Actual Demand (kW)
      </span>
    </th>

    <th *ngIf="billedForDemand == BilledForDemand.REAL_POWER && adjustedOrActual == AdjustedOrActual.BOTH">
      Power Factor
    </th>
  </tr>

  <tr class="form-group form-array"
    *ngFor="let group of monthyInputsFormArray.controls; let i = index; let last = last">
    <ng-container [formGroup]="group">
      <td>
        <input type="text" step="any" formControlName="month" id="{{'month_'+i}}" (input)="calculate()">
      </td>

      <td
        *ngIf="(billedForDemand == BilledForDemand.REAL_POWER && adjustedOrActual != AdjustedOrActual.ACTUAL_DEMAND) || billedForDemand == BilledForDemand.APPARENT_POWER">
        <input type="number" step="any" formControlName="pfAdjustedDemand" id="{{'pfAdjustedDemand'+i}}" (input)="calculate()" (focus)="focusField('pfAdjustedDemand')">
          <span *ngIf="group.get('pfAdjustedDemand')?.errors?.required" class="alert-danger pull-right small">Value Required</span>
          <span *ngIf="group.get('pfAdjustedDemand')?.errors?.greaterThan == 0" class="alert-danger pull-right small">Value must be greater than {{group.get('pfAdjustedDemand')?.errors?.greaterThan}}</span>
          <span class="alert-danger pull-right small" *ngIf="group.get('pfAdjustedDemand')?.errors?.adjustedVsActualError">
            {{group.get('pfAdjustedDemand').errors.adjustedVsActualError}}
          </span>
          <span class="alert-danger pull-right small" *ngIf="group.get('pfAdjustedDemand')?.errors?.apparentVsActualError">
            {{group.get('pfAdjustedDemand').errors.apparentVsActualError}}
          </span>
      </td>
      <td *ngIf="adjustedOrActual == AdjustedOrActual.ACTUAL_DEMAND || adjustedOrActual == AdjustedOrActual.BOTH">
        <input type="number" step="any" formControlName="actualDemand" id="{{'actualDemand_'+i}}" (input)="calculate()" (focus)="focusField('actualDemand')">
        <span *ngIf="group.get('actualDemand')?.errors?.required" class="alert-danger pull-right small">Value Required</span>
        <span *ngIf="group.get('actualDemand')?.errors?.greaterThan == 0" class="alert-danger pull-right small">Value must be greater than {{group.get('actualDemand')?.errors?.greaterThan}}</span>
        <span class="alert-danger pull-right small"
          *ngIf="group.get('actualDemand')?.invalid && group.get('actualDemand')?.errors?.adjustedVsActualError">
          {{group.get('actualDemand').errors.adjustedVsActualError}}
        </span>
        <span class="alert-danger pull-right small" *ngIf="group.get('actualDemand')?.errors?.apparentVsActualError">
            {{group.get('actualDemand').errors.apparentVsActualError}}
      </span>
      </td>
      <td
        *ngIf="billedForDemand == BilledForDemand.REAL_POWER || (billedForDemand == BilledForDemand.APPARENT_POWER && adjustedOrActual == AdjustedOrActual.POWER_FACTOR)">
        <input type="number" step="any" formControlName="powerFactor" id="{{'powerFactor_'+i}}" (input)="calculate()" (focus)="focusField('powerFactor')">
          <span *ngIf="group.get('powerFactor')?.errors?.required" class="alert-danger pull-right small">Value Required.</span>
          <span *ngIf="group.get('powerFactor')?.errors?.min" class="alert-danger pull-right small">Value can't be less than {{group.get('powerFactor')?.errors?.min.min}}</span>
          <span *ngIf="group.get('powerFactor')?.errors?.max" class="alert-danger pull-right small">Value can't be greater than {{group.get('powerFactor')?.errors?.max.max}}</span>
      </td>
    </ng-container>
  </tr>

</table>

<div class="w-100 justify-content-center btn-group btn-group-sm">
  <button type="button" class="btn btn-primary pull-left btn-sm m-2 btn-form" (click)="btnAddMonth()">
    Add Month
  </button>
  <button type="button" class="btn btn-danger pull-left btn-sm m-2 btn-form" (click)="btnDeleteLastMonth()"
    [disabled]="data.monthyInputs.length == 3">
    Delete Last Month
  </button>

</div>